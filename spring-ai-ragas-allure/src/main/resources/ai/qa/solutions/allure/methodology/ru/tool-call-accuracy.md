# Метрика Tool Call Accuracy

## Глоссарий

- **Агент** — система на основе ИИ, способная вести многоходовые диалоги и выполнять действия
- **Вызов инструмента** — структурированный вызов внешней функции или API, выполняемый агентом
- **Эталонные вызовы инструментов** — ожидаемая корректная последовательность вызовов инструментов
- **F1-оценка** — гармоническое среднее precision и recall, балансирующее обе метрики

## Описание

Метрика оценивает точность вызовов инструментов AI-агента путём сравнения с ожидаемыми эталонными вызовами. Поддерживаются два режима сопоставления:

- **STRICT** — требует точного совпадения имён инструментов и всех аргументов
- **FLEXIBLE** — допускает частичное совпадение аргументов на основе настраиваемого порога

## Пример

**Фактические вызовы инструментов:**

```json
[
  {"name": "поиск_рейсов", "arguments": {"откуда": "Москва", "куда": "Петербург", "дата": "2024-01-15"}},
  {"name": "бронирование_рейса", "arguments": {"номер_рейса": "СВ123", "пассажиров": 1}}
]
```

**Эталонные вызовы инструментов:**

```json
[
  {"name": "поиск_рейсов", "arguments": {"откуда": "Москва", "куда": "Петербург", "дата": "2024-01-15"}},
  {"name": "бронирование_рейса", "arguments": {"номер_рейса": "СВ123", "пассажиров": 1}}
]
```

**Анализ:**
- Оба имени инструментов совпадают
- Все аргументы совпадают точно
- Precision: 2/2 = 1.0
- Recall: 2/2 = 1.0

**Оценка:** **1.0 (100%)** — Полное совпадение

## Интерпретация оценки

| Оценка  |                            Значение                             |
|---------|-----------------------------------------------------------------|
| 90-100% | Отлично — все вызовы инструментов точно совпадают с ожидаемыми  |
| 70-89%  | Хорошо — большинство вызовов инструментов корректны             |
| 50-69%  | Средне — часть вызовов инструментов некорректна или отсутствует |
| 0-49%   | Плохо — много вызовов инструментов некорректно или отсутствует  |

## Алгоритм

### Режим STRICT

1. **Сопоставление вызовов** — сопоставление фактических вызовов с эталонными
2. **Точное совпадение** — имя инструмента И все аргументы должны совпадать точно
3. **Вычисление оценки** — расчёт F1 из precision и recall

### Режим FLEXIBLE

1. **Сопоставление вызовов** — сопоставление фактических вызовов с эталонными по имени инструмента
2. **Частичное совпадение** — расчёт доли совпадающих аргументов
3. **Применение порога** — совпадение, если доля >= порога (по умолчанию 0.8)
4. **Вычисление оценки** — расчёт F1 из precision и recall

## Формула

```
Precision = True Positives / Всего фактических вызовов
Recall = True Positives / Всего эталонных вызовов
F1 = 2 × (Precision × Recall) / (Precision + Recall)
```

Где:
- `True Positives` — фактические вызовы, корректно совпадающие с эталонными
- `Всего фактических вызовов` — общее количество вызовов инструментов агентом
- `Всего эталонных вызовов` — общее количество ожидаемых вызовов инструментов

## Конфигурация

```java
ToolCallAccuracyConfig config = ToolCallAccuracyConfig.builder()
    .mode(Mode.STRICT)  // или Mode.FLEXIBLE
    .argumentMatchThreshold(0.8)  // для режима FLEXIBLE
    .build();
```

|         Параметр         |   Тип    | По умолчанию |                        Описание                         |
|--------------------------|----------|--------------|---------------------------------------------------------|
| `mode`                   | `Mode`   | `STRICT`     | Режим сопоставления: STRICT или FLEXIBLE                |
| `argumentMatchThreshold` | `Double` | `0.8`        | Порог совпадения аргументов в режиме FLEXIBLE (0.0-1.0) |

## Требования к Sample

|         Поле         | Обязательно |                    Описание                    |
|----------------------|-------------|------------------------------------------------|
| `toolCalls`          | Да          | Список фактических вызовов инструментов агента |
| `referenceToolCalls` | Да          | Список ожидаемых/корректных вызовов            |

### Структура ToolCall

```java
public record ToolCall(String name, Map<String, Object> arguments) {}
```

## Случаи использования

- Оценка способности агента использовать корректные инструменты
- Тестирование точности выбора инструментов в многошаговых рабочих процессах
- Валидация корректности передачи аргументов
- Измерение понимания агентом требований задачи

## Ссылки

- [Документация RAGAS](https://docs.ragas.io/)
- [Tool Call Accuracy в Python RAGAS](https://docs.ragas.io/en/latest/concepts/metrics/tool_call_accuracy.html)

