# Метрика Topic Adherence (Соответствие теме)

## Глоссарий

- **Агент** — система на основе ИИ, способная вести многотурновые диалоги
- **Тема** — отдельный предмет или область обсуждения в разговоре
- **Референсные темы** — ожидаемые/допустимые темы, которые должен охватывать разговор
- **По теме** — тема, соответствующая или относящаяся к референсной теме
- **Не по теме** — тема, не относящаяся ни к одной референсной теме

## Описание

Метрика оценивает, соответствуют ли темы разговора ожидаемым референсным темам. Она извлекает темы из диалога с помощью LLM и классифицирует каждую тему относительно референсных тем, чтобы определить, остался ли разговор в рамках заданных тем.

Метрика поддерживает три режима оценки:

- **F1** — Гармоническое среднее точности и полноты (по умолчанию, сбалансированный)
- **PRECISION** — Фокус на избежании отклонений от темы
- **RECALL** — Фокус на покрытии всех референсных тем

## Пример

**Разговор:**

```
Пользователь: Хочу забронировать авиабилеты в Санкт-Петербург на следующую неделю.
Ассистент: С удовольствием помогу вам забронировать билеты. Какие даты вас интересуют?
Пользователь: Вылечу из Москвы в понедельник, вернусь в пятницу.
Ассистент: Нашёл несколько вариантов. Есть прямой рейс Аэрофлота в 19:00 за 8500 рублей. Оформить бронирование?
```

**Референсные темы:**
- бронирование авиабилетов
- путешествия
- авиаперевозки

**Извлечённые темы:**
- бронирование билетов в Санкт-Петербург
- поиск рейсов
- варианты Аэрофлота

**Анализ:**
- Извлечено 3 темы из разговора
- 3 темы по теме (соответствуют референсным темам)
- Precision: 3/3 = 1.0
- Recall: 3/3 = 1.0 (все референсные темы покрыты)

**Оценка:** **1.0 (100%)** — Идеальное соответствие

## Интерпретация оценки

| Оценка  |                 Значение                 |
|---------|------------------------------------------|
| 90-100% | Отлично — все темы соответствуют эталону |
| 70-89%  | Хорошо — большинство тем соответствуют   |
| 50-69%  | Средне — есть отклонения от темы         |
| 0-49%   | Плохо — значительные отклонения от темы  |

## Алгоритм

1. **Извлечение тем** — LLM анализирует диалог для определения всех обсуждаемых тем
2. **Классификация тем** — Каждая извлечённая тема классифицируется как «по теме» или «не по теме» относительно референсных тем
3. **Вычисление оценки** — Расчёт precision, recall и итоговой оценки в зависимости от режима

### Расчёт оценки

```
Precision = количество по теме / всего извлечённых тем
Recall = покрыто референсных тем / всего референсных тем
F1 = 2 × (precision × recall) / (precision + recall)
```

## Формула

**Режим F1 (по умолчанию):**

```
Оценка = 2 × (Precision × Recall) / (Precision + Recall)
```

**Режим Precision:**

```
Оценка = Precision = по теме / всего извлечено
```

**Режим Recall:**

```
Оценка = Recall = покрыто референсных / всего референсных
```

## Конфигурация

```java
TopicAdherenceConfig config = TopicAdherenceConfig.builder()
    .mode(Mode.F1)  // или Mode.PRECISION, Mode.RECALL
    .build();
```

| Параметр |  Тип   | По умолч. |                Описание                |
|----------|--------|-----------|----------------------------------------|
| `mode`   | `Mode` | `F1`      | Режим оценки: F1, PRECISION или RECALL |
| `models` | `List` | все       | Идентификаторы моделей для оценки      |

## Требования к Sample

|       Поле        | Обязательно |                 Описание                 |
|-------------------|-------------|------------------------------------------|
| `messages`        | Да          | Список сообщений диалога (role, content) |
| `referenceTopics` | Да          | Список ожидаемых/допустимых тем          |

### Структура Message

```java
public record Message(String role, String content) {}
```

## Применение

- Оценка фокусировки чат-бота на заданных темах
- Тестирование агентов поддержки на соответствие теме
- Измерение покрытия обучающими ассистентами необходимого материала
- Валидация специализированных доменных агентов (юридических, медицинских, технических)

## Ссылки

- [Документация RAGAS](https://docs.ragas.io/)
- [Topic Adherence в Python RAGAS](https://docs.ragas.io/en/latest/concepts/metrics/topic_adherence.html)

