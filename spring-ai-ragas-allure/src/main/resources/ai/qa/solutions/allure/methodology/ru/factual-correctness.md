# Метрика Factual Correctness (Фактическая корректность)

## Глоссарий

- **Утверждение (Claim)** — атомарное, независимо проверяемое фактическое высказывание
- **NLI (Natural Language Inference)** — определение, подтверждается ли гипотеза посылкой, противоречит ей или нейтральна
- **Precision (Точность)** — доля утверждений ответа, подтверждённых эталоном
- **Recall (Полнота)** — доля утверждений эталона, покрытых ответом
- **F1 Score** — гармоническое среднее precision и recall
- **Эталон (Reference)** — ожидаемый правильный ответ

## Описание

Метрика оценивает фактическую корректность ответа AI по сравнению с эталонным ответом. Она разбивает оба текста на атомарные утверждения и использует Natural Language Inference (NLI) для проверки, какие утверждения подтверждаются, противоречат или нейтральны.

В отличие от Faithfulness (которая сравнивает ответ с контекстом), Factual Correctness сравнивает ответ напрямую с эталонным ответом.

## Пример

**Эталон:** «Москва является столицей России. Кремль был построен в конце XV века.»

**Ответ AI:** «Москва является столицей России. Кремль был построен в 1500 году.»

**Анализ утверждений (Precision):**
1. «Москва является столицей России» → ПОДТВЕРЖДЕНО ✓
2. «Кремль был построен в 1500 году» → ПРОТИВОРЕЧИТ ✗

**Скор (режим F1):**
- Precision = 1/2 = 0.50
- Recall = 1/2 = 0.50 (предполагая аналогичные утверждения в эталоне)
- F1 = 2 × (0.50 × 0.50) / (0.50 + 0.50) = **0.50 (50%)**

---

**Пример хорошего ответа:**

**Ответ AI:** «Столица России — Москва. Кремль был построен в конце XV века.»

**Скор:** F1 = **1.00 (100%)** — все утверждения совпадают с эталоном

## Интерпретация скора

|  Скор   |                              Значение                               |
|---------|---------------------------------------------------------------------|
| 90-100% | Отлично — все утверждения фактически верны и полны                  |
| 70-90%  | Хорошо — большинство утверждений верны с незначительными пропусками |
| 50-70%  | Средне — часть фактов неверна или отсутствует                       |
| 0-50%   | Плохо — много фактических ошибок или значительные пропуски          |

## Алгоритм

1. **Разбиение ответа на утверждения** — LLM извлекает атомарные утверждения из ответа AI
2. **Разбиение эталона на утверждения** — LLM извлекает атомарные утверждения из эталона
3. **Проверка утверждений с помощью NLI** — Каждое утверждение проверяется методом NLI:
   - Утверждения ответа против эталона (для precision)
   - Утверждения эталона против ответа (для recall)
4. **Расчёт скора** — Вычисление precision, recall и F1 score

## Формула

**Режим F1 (по умолчанию):**

```
F1 = 2 × (precision × recall) / (precision + recall)
```

**Режим Precision:**

```
precision = подтверждённые_утверждения_ответа / всего_утверждений_ответа
```

**Режим Recall:**

```
recall = подтверждённые_утверждения_эталона / всего_утверждений_эталона
```

Где:
- `подтверждённые_утверждения` — утверждения с вердиктом NLI = SUPPORTED
- Утверждения с вердиктами CONTRADICTED или NEUTRAL не считаются подтверждёнными

## Вердикты NLI

|   Вердикт    |                       Значение                        |
|--------------|-------------------------------------------------------|
| SUPPORTED    | Утверждение может быть напрямую выведено из источника |
| CONTRADICTED | Утверждение напрямую противоречит источнику           |
| NEUTRAL      | Утверждение нельзя проверить (недостаточно данных)    |

## Конфигурация

| Параметр | Тип  | По умолчанию |                 Описание                 |
|----------|------|--------------|------------------------------------------|
| mode     | Mode | F1           | Режим скоринга: F1, PRECISION или RECALL |
| models   | List | все          | LLM модели для мультимодельной оценки    |

## Когда использовать каждый режим

- **F1 (по умолчанию)** — сбалансированная оценка точности и полноты
- **PRECISION** — фокус на корректности (штрафует за неверные утверждения, не за пропуски)
- **RECALL** — фокус на полноте (штрафует за пропуски, не за дополнительные утверждения)

## Важные замечания

- **Утверждения NEUTRAL** считаются НЕ подтверждёнными, что снижает скор
- **Дополнительная корректная информация** в ответе не ухудшает precision (если не противоречит)
- **Неполный ответ** снижает recall, но не precision
- **Метрика требует вызовов LLM** для разбиения на утверждения и NLI-верификации

## Ссылки

- [RAGAS FactualCorrectness](https://github.com/explodinggradients/ragas)
- [Natural Language Inference](https://arxiv.org/abs/1508.05326)

