# Метрика Answer Correctness (Корректность ответа)

## Обзор

Answer Correctness — это составная метрика, которая оценивает соответствие ответа AI эталонному ответу, объединяя два взаимодополняющих подхода:

1. **Фактическая корректность (75% по умолчанию)** — проверяет правильность конкретных фактов через декомпозицию утверждений и NLI
2. **Семантическое сходство (25% по умолчанию)** — обеспечивает сохранение общего смысла через сходство эмбеддингов

Такой двойной подход обеспечивает всестороннюю оценку, выявляя как конкретные фактические ошибки, так и общий дрейф смысла.

## Глоссарий

|          Термин          |                   Определение                   |
|--------------------------|-------------------------------------------------|
| Response (Ответ)         | Ответ, сгенерированный AI для оценки            |
| Reference (Эталон)       | Эталонный или ожидаемый ответ                   |
| Фактическая корректность | Оценка точности отдельных фактов через NLI      |
| Семантическое сходство   | Оценка сохранения смысла через эмбеддинги       |
| Взвешенное среднее       | Комбинация обеих оценок с настраиваемыми весами |

## Алгоритм

### Шаг 1: Вычисление фактической корректности

Вызывается FactualCorrectnessMetric для:
1. Декомпозиции ответа на атомарные утверждения
2. Декомпозиции эталона на атомарные утверждения
3. Верификации утверждений с помощью Natural Language Inference
4. Расчёта оценки F1/Precision/Recall

### Шаг 2: Вычисление семантического сходства

Вызывается SemanticSimilarityMetric для:
1. Генерации эмбеддингов для ответа и эталона
2. Расчёта косинусного сходства между векторами

### Шаг 3: Комбинирование оценок

Вычисление взвешенного среднего:

```
score = factualWeight × factualScore + semanticWeight × semanticScore
```

## Формула

**Комбинированная оценка:**

```
AnswerCorrectness = w_f × FactualCorrectness + w_s × SemanticSimilarity
```

Где:
- `w_f` = вес фактической корректности (по умолчанию 0.75)
- `w_s` = вес семантического сходства (по умолчанию 0.25)
- `w_f + w_s = 1.0`

## Конфигурация

```java
AnswerCorrectnessMetric.AnswerCorrectnessConfig config =
    AnswerCorrectnessMetric.AnswerCorrectnessConfig.builder()
        .factualWeight(0.75)  // Вес фактической корректности
        .semanticWeight(0.25) // Вес семантического сходства
        .models(List.of("model-1", "model-2"))
        .build();
```

### Предустановленные конфигурации

|       Пресет        | Вес факт. | Вес семант. |          Применение           |
|---------------------|-----------|-------------|-------------------------------|
| `defaultConfig()`   | 75%       | 25%         | Общее применение              |
| `equalWeights()`    | 50%       | 50%         | Сбалансированная оценка       |
| `factualFocused()`  | 90%       | 10%         | Критичные к фактам приложения |
| `semanticFocused()` | 10%       | 90%         | Критичные к смыслу приложения |

## Интерпретация оценки

| Диапазон  | Уровень |                          Интерпретация                           |
|-----------|---------|------------------------------------------------------------------|
| 0.9 - 1.0 | Отлично | Фактически корректен и семантически согласован                   |
| 0.7 - 0.9 | Хорошо  | В основном корректен с хорошим сходством                         |
| 0.5 - 0.7 | Средне  | Некоторые проблемы с фактами или смыслом                         |
| 0.0 - 0.5 | Плохо   | Значительные фактические ошибки или семантическое несоответствие |

## Пример использования

```java
Sample sample = Sample.builder()
    .response("Москва является столицей России. Кремль расположен в Москве.")
    .reference("Москва является столицей России. Кремль расположен в Москве.")
    .build();

Double score = answerCorrectnessMetric.singleTurnScore(sample);
// Возвращает: ~0.95 (высокое фактическое совпадение + высокое семантическое сходство)
```

## Когда использовать

**Подходит для:**
- Всесторонней оценки качества ответа
- Выявления как фактических ошибок, так и дрейфа смысла
- Приложений, требующих как точности, так и семантического понимания

**Рассмотрите альтернативы когда:**
- Важна только фактическая точность → Используйте FactualCorrectnessMetric
- Важно только сохранение смысла → Используйте SemanticSimilarityMetric
- Нужен детальный анализ на уровне утверждений → Используйте FactualCorrectnessMetric напрямую

## Зависимости

Эта метрика внутренне использует:
- `FactualCorrectnessMetric` для верификации фактов
- `SemanticSimilarityMetric` для сходства эмбеддингов

Оба должны быть доступны в Spring-контексте.
